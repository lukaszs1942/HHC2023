---
icon: material/text-box-outline
---

# Active Directory

**Difficulty**: :fontawesome-solid-star::fontawesome-solid-star::fontawesome-solid-star::fontawesome-solid-star::fontawesome-regular-star:<br/>
**Direct link**: [Objective6.zip](https://.../)

## Objective

!!! question "Request"
    Go to Steampunk Island and help Ribb Bonbowford audit the Azure AD environment. What's the name of the secret file in the inaccessible folder on the FileShare?

??? quote "Ribb Bonbowford"
    Hello, I'm Ribb Bonbowford. Nice to meet you!<br/>
    Oh golly! It looks like Alabaster deployed some vulnerable Azure Function App Code he got from ChatNPT.<br/>
    Don't get me wrong, I'm all for testing new technologies. The problem is that Alabaster didn't review the generated code and used the Geese Islands Azure production environment for his testing.<br/>
    I'm worried because our Active Directory server is hosted there and Wombley Cube's research department uses one of its fileshares to store their sensitive files.<br/>
    I'd love for you to help with auditing our Azure and Active Directory configuration and ensure there's no way to access the research department's data.<br/>
    Since you have access to Alabaster's SSH account that means you're already in the Azure environment. Knowing Alabaster, there might even be some useful tools in place already.

## Hints

??? tip "Useful Tools"
    It looks like Alabaster's SSH account has a couple of tools installed which might prove useful.

??? tip "Misconfiguration ADventures"
    Certificates are everywhere. Did you know Active Directory (AD) uses certificates as well? Apparently the service used to manage them can have misconfigurations too.

## Solution

Once we gained access to Alabaster account We can see list of tools which might help us on auditing Azure AD enviroment.

First we obtain token from Metadata service:

```bash
curl 'http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https%3A%2F%2Fmanagement.azure.com%2F' -H Metadata:true -s
```

```json title="RESPONSE with TOKEN"
{"access_token":"eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6IjVCM25SeHRRN2ppOGVORGMzRnkwNUtmOTdaRSIsImtpZCI6IjVCM25SeHRRN2ppOGVORGMzRnkwNUtmOTdaRSJ9.eyJhdWQiOiJodHRwczovL21hbmFnZW1lbnQuYXp1cmUuY29tLyIsImlzcyI6Imh0dHBzOi8vc3RzLndpbmRvd3MubmV0LzkwYTM4ZWRhLTQwMDYtNGRkNS05MjRjLTZjYTU1Y2FjYzE0ZC8iLCJpYXQiOjE3MDQxOTc1NjcsIm5iZiI6MTcwNDE5NzU2NywiZXhwIjoxNzA0Mjg0MjY3LCJhaW8iOiJFMlZnWU9ncjZKcjZJL3ZxWFRtMkI0cU1VclZiQUE9PSIsImFwcGlkIjoiYjg0ZTA2ZDMtYWJhMS00YmNjLTk2MjYtMmUwZDc2Y2JhMmNlIiwiYXBwaWRhY3IiOiIyIiwiaWRwIjoiaHR0cHM6Ly9zdHMud2luZG93cy5uZXQvOTBhMzhlZGEtNDAwNi00ZGQ1LTkyNGMtNmNhNTVjYWNjMTRkLyIsImlkdHlwIjoiYXBwIiwib2lkIjoiNjAwYTNiYzgtN2UyYy00NGU1LThhMjctMThjM2ViOTYzMDYwIiwicmgiOiIwLkFGRUEybzZqa0FaQTFVMlNUR3lsWEt6QlRVWklmM2tBdXRkUHVrUGF3ZmoyTUJQUUFBQS4iLCJzdWIiOiI2MDBhM2JjOC03ZTJjLTQ0ZTUtOGEyNy0xOGMzZWI5NjMwNjAiLCJ0aWQiOiI5MGEzOGVkYS00MDA2LTRkZDUtOTI0Yy02Y2E1NWNhY2MxNGQiLCJ1dGkiOiJFSXp1Z2dHWWxVZXpNRWFPNmRrQ0JnIiwidmVyIjoiMS4wIiwieG1zX2F6X3JpZCI6Ii9zdWJzY3JpcHRpb25zLzJiMDk0MmYzLTliY2EtNDg0Yi1hNTA4LWFiZGFlMmRiNWU2NC9yZXNvdXJjZWdyb3Vwcy9ub3J0aHBvbGUtcmcxL3Byb3ZpZGVycy9NaWNyb3NvZnQuQ29tcHV0ZS92aXJ0dWFsTWFjaGluZXMvc3NoLXNlcnZlci12bSIsInhtc19jYWUiOiIxIiwieG1zX21pcmlkIjoiL3N1YnNjcmlwdGlvbnMvMmIwOTQyZjMtOWJjYS00ODRiLWE1MDgtYWJkYWUyZGI1ZTY0L3Jlc291cmNlZ3JvdXBzL25vcnRocG9sZS1yZzEvcHJvdmlkZXJzL01pY3Jvc29mdC5NYW5hZ2VkSWRlbnRpdHkvdXNlckFzc2lnbmVkSWRlbnRpdGllcy9ub3J0aHBvbGUtc3NoLXNlcnZlci1pZGVudGl0eSIsInhtc190Y2R0IjoxNjk4NDE3NTU3fQ.IWhezoNaO1CXWr3WxpLQ8fBXpot_rb_VnGQTpG3-5mA04JXOMLTTy0eyvcb-PVLktN0dIgLqaELrGJ4nnGI2vD79xXZMoSfBt4ov9Nbq3wPaLQChD2AEkBYHey5WjrTfdngP7Cuy1yKH7t1jIJEPIGmZaNRescVMHS9HO9rZAck7yq1gpTAtQRQaMQWuSTQAhTEPdVtuqUItPqpXoWu4U6fS8JOf9NNvAndtxl9xGgiWbjWtuubDWZdKT1bXo4talKTwHghfGOZRc7tp8GFMgB3Yrm3Z8UW402THs1l4FeiNaZlZBAmODyawFiYD6D4pYcnzW1C-HsY_6vBqbwKpfw","client_id":"b84e06d3-aba1-4bcc-9626-2e0d76cba2ce","expires_in":"84172","expires_on":"1704284267","ext_expires_in":"86399","not_before":"1704197567","resource":"https://management.azure.com/","token_type":"Bearer"}
```


```json
curl -H "Authorization: Bearer <TOKEN>" 'https://management.azure.com/subscriptions?api-version=2022-12-01' | python -m json.tool
```

```json title=Output
{
    "value": [
        {
            "id": "/subscriptions/2b0942f3-9bca-484b-a508-abdae2db5e64",
            "authorizationSource": "RoleBased",
            "managedByTenants": [],
            "tags": {
                "sans:application_owner": "SANS:R&D",
                "finance:business_unit": "curriculum"
            },
            "subscriptionId": "2b0942f3-9bca-484b-a508-abdae2db5e64",
            "tenantId": "90a38eda-4006-4dd5-924c-6ca55cacc14d",
            "displayName": "sans-hhc",
            "state": "Enabled",
            "subscriptionPolicies": {
                "locationPlacementId": "Public_2014-09-01",
                "quotaId": "EnterpriseAgreement_2014-09-01",
                "spendingLimit": "Off"
            }
        }
    ],
    "count": {
        "type": "Total",
        "value": 1
    }
}
```

Now let's query resources groups for this subscription

```sh
curl -H "Authorization: Bearer <TOKEN>" 'https://management.azure.com/subscriptions/2b0942f3-9bca-484b-a508-abdae2db5e64/resourceGroups?api-version=2020-01-01' | python -m json.tool
```

```json title=OUTPUT
{
    "value": [
        {
            "id": "/subscriptions/2b0942f3-9bca-484b-a508-abdae2db5e64/resourceGroups/northpole-rg1",
            "name": "northpole-rg1",
            "type": "Microsoft.Resources/resourceGroups",
            "location": "eastus",
            "tags": {},
            "properties": {
                "provisioningState": "Succeeded"
            }
        }
    ]
}
```
Now let's try to get list of KeyVauls

```sh
curl -X GET -H "Authorization: Bearer <Access-Token>" \
-H "Content-Type: application/json" \
https://management.azure.com/subscriptions/2b0942f3-9bca-484b-a508-abdae2db5e64/resourceGroups/northpole-rg1/providers/Microsoft.KeyVault/vaults?api-version=2019-09-01
| python -m json.tool
```

```json
{
    "value": [
        {
            "id": "/subscriptions/2b0942f3-9bca-484b-a508-abdae2db5e64/resourceGroups/northpole-rg1/providers/Microsoft.KeyVault/vaults/northpole-it-kv",
            "name": "northpole-it-kv",
            "type": "Microsoft.KeyVault/vaults",
            "location": "eastus",
            "tags": {},
            "properties": {
                "sku": {
                    "family": "A",
                    "name": "Standard"
                },
                "tenantId": "90a38eda-4006-4dd5-924c-6ca55cacc14d",
                "accessPolicies": [],
                "enabledForDeployment": false,
                "enabledForDiskEncryption": false,
                "enabledForTemplateDeployment": false,
                "enableSoftDelete": true,
                "softDeleteRetentionInDays": 90,
                "enableRbacAuthorization": true,
                "vaultUri": "https://northpole-it-kv.vault.azure.net/",
                "provisioningState": "Succeeded"
            }
        },
        {
            "id": "/subscriptions/2b0942f3-9bca-484b-a508-abdae2db5e64/resourceGroups/northpole-rg1/providers/Microsoft.KeyVault/vaults/northpole-ssh-certs-kv",
            "name": "northpole-ssh-certs-kv",
            "type": "Microsoft.KeyVault/vaults",
            "location": "eastus",
            "tags": {},
            "properties": {
                "sku": {
                    "family": "A",
                    "name": "standard"
                },
                "tenantId": "90a38eda-4006-4dd5-924c-6ca55cacc14d",
                "accessPolicies": [
                    {
                        "tenantId": "90a38eda-4006-4dd5-924c-6ca55cacc14d",
                        "objectId": "0bc7ae9d-292d-4742-8830-68d12469d759",
                        "permissions": {
                            "keys": [
                                "all"
                            ],
                            "secrets": [
                                "all"
                            ],
                            "certificates": [
                                "all"
                            ],
                            "storage": [
                                "all"
                            ]
                        }
                    },
                    {
                        "tenantId": "90a38eda-4006-4dd5-924c-6ca55cacc14d",
                        "objectId": "1b202351-8c85-46f1-81f8-5528e92eb7ce",
                        "permissions": {
                            "secrets": [
                                "get"
                            ]
                        }
                    }
                ],
                "enabledForDeployment": false,
                "enableSoftDelete": true,
                "softDeleteRetentionInDays": 90,
                "vaultUri": "https://northpole-ssh-certs-kv.vault.azure.net/",
                "provisioningState": "Succeeded"
            }
        }
    ],
    "nextLink": "https://management.azure.com/subscriptions/2b0942f3-9bca-484b-a508-abdae2db5e64/resourceGroups/northpole-rg1/providers/Microsoft.KeyVault/vaults?api-version=2019-09-01&$skiptoken=bm9ydGhwb2xlLXNzaC1jZXJ0cy1rdg=="
}


```

### Admonitions

!!! warning "Anchor the decorations"
    Ensure that all fesnotive decorations, especially electrical ones, are securely anchored. We don’t want them floating off into the tropical sunset!

!!! info "Palm tree lighting"
    While on the island, make sure to hang your Christmas lights on a palm tree. It’s not only festive but also a great beacon for Santa to find you!

### Images

![Terminal output](../img/objectives/o5/terminal_output_o5.png)


## Response

!!! quote "Ribb Bonbowford"
    Wow, nice work. I'm impressed!<br/>
    This is all starting to feel like more than just a coincidence though. Everything Alabaster's been setting up lately with the help of ChatNPT contains all these vulnerabilities. It almost feels deliberate, if you ask me.<br/>
    Now obviously an LLM AI like ChatNPT cannot have deliberate motivations itself. It's just a machine. But I wonder who could have built it and who is controlling it?<br/>
    On top of that, we apparently have a satellite ground station on Geese Islands. I wonder where that thing would even be located.<br/>
    Well, I guess it's probably somewhere on Space Island, but I've not been there yet.<br/>
    I'm not a big fan of jungles, you see. I have this tendency to get lost in them.<br/>
    Anyway, if you feel like investigating, that'd be where I'd go look.<br/>
    Good luck and I'd try and steer clear of ChatNPT if I were you. 
